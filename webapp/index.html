<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–û–Ω–æ–≤–ª–µ–Ω–Ω—è –°—Ç–∞—Ç—É—Å—É</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –°—Ç–∏–ª—ñ –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤–∏–≥–ª—è–¥—É Telegram Mini App */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background-color: var(--tg-theme-bg-color, #f4f4f5);
      color: var(--tg-theme-text-color, #000000);
      transition: background-color 0.3s, color 0.3s;
    }

    /* –ó–∞–≥–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –ø–æ–ª—ñ–≤ —Ç–∞ —Ñ–æ—Ä–º */
    .form-group {
      margin-bottom: 20px;
      padding: 10px;
      background-color: var(--tg-theme-secondary-bg-color, #ffffff);
      border-radius: 10px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--tg-theme-link-color, #8e8e93);
      border-radius: 5px;
      box-sizing: border-box;
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
    }

    .role-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .role-options label {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid var(--tg-theme-secondary-bg-color, #d1d1d6);
      background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
      cursor: pointer;
      transition: background-color 0.2s;
      font-weight: normal;
    }

    .role-options input[type="radio"] {
      display: none;
    }

    .role-options input[type="radio"]:checked+label {
      background-color: var(--tg-theme-button-color, #007aff);
      color: var(--tg-theme-button-text-color, #ffffff);
      border-color: var(--tg-theme-button-color, #007aff);
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      flex-grow: 1;
      margin: 0 5px;
    }

    .btn-confirm {
      background-color: var(--tg-theme-button-color, #007aff);
      color: var(--tg-theme-button-text-color, #ffffff);
    }

    .btn-cancel {
      background-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
      color: var(--tg-theme-text-color, #000000);
    }

    .error-message {
      color: red;
      margin-top: -10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <h1>–û–Ω–æ–≤–ª–µ–Ω–Ω—è –°—Ç–∞—Ç—É—Å—É –ì–ª–∞–≤–∏</h1>

  <form id="statusForm">
    <div class="form-group">
      <label for="titleSelect">–¢–∞–π—Ç–ª:</label>
      <select id="titleSelect" name="title" required>
        <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∞–π—Ç–ª...</option>
      </select>
      <div id="titleError" class="error-message"></div>
    </div>

    <div class="form-group">
      <label for="chapterNumberInput">–ù–æ–º–µ—Ä —Ä–æ–∑–¥—ñ–ª—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 1.0 –∞–±–æ 15):</label>
      <input type="text" id="chapterNumberInput" name="chapter_number" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ä–æ–∑–¥—ñ–ª—É" required />
      <div id="chapterError" class="error-message"></div>
    </div>

    <div class="form-group">
      <label>–†–æ–ª—å:</label>
      <div class="role-options">
        <input type="radio" id="role_klink" name="role" value="–∫–ª—ñ–Ω" required />
        <label for="role_klink">–ö–ª—ñ–Ω</label>

        <input type="radio" id="role_translate" name="role" value="–ø–µ—Ä–µ–∫–ª–∞–¥" required />
        <label for="role_translate">–ü–µ—Ä–µ–∫–ª–∞–¥</label>

        <input type="radio" id="role_type" name="role" value="—Ç–∞–π–ø" required />
        <label for="role_type">–¢–∞–π–ø</label>

        <input type="radio" id="role_redact" name="role" value="—Ä–µ–¥" required />
        <label for="role_redact">–†–µ–¥–∞–∫—Ç</label>
      </div>
      <div id="roleError" class="error-message"></div>
    </div>

    <div class="form-group">
      <label for="dateInput">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (YYYY-MM-DD):</label>
      <input type="date" id="dateInput" name="completion_date" required />
      <div id="dateError" class="error-message"></div>
    </div>

    <div class="actions">
      <button type="button" class="btn btn-confirm" id="confirmBtn">
        –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
      </button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const titleSelect = document.getElementById('titleSelect');
      const chapterNumberInput = document.getElementById('chapterNumberInput');
      const dateInput = document.getElementById('dateInput');
      const confirmBtn = document.getElementById('confirmBtn');
      // const cancelBtn = document.getElementById('cancelBtn'); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ BackButton
      const form = document.getElementById('statusForm');

      // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –¥–∞—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è WebApp
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ—ó –∫–Ω–æ–ø–∫–∏
        Telegram.WebApp.MainButton.setText('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –û–Ω–æ–≤–ª–µ–Ω–Ω—è');
        Telegram.WebApp.MainButton.show();
        Telegram.WebApp.enableClosingConfirmation();

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç–∞–π—Ç–ª—ñ–≤ (–ï–º—É–ª—è—Ü—ñ—è, –ø–æ–∫–∏ –Ω–µ–º–∞—î API-–µ–Ω–¥–ø–æ—ñ–Ω—Ç—É)
        const titles = ["–í–í", "–ö—ñ—Ç", "–°–µ–º–ø–∞–π", "–Ü–Ω—à–∏–π –¢–∞–π—Ç–ª"]; // –ü—Ä–∏–∫–ª–∞–¥
        titles.forEach(title => {
          const option = document.createElement('option');
          option.value = title;
          option.textContent = title;
          titleSelect.appendChild(option);
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è MainButton
        Telegram.WebApp.onEvent('mainButtonClicked', () => {
          // –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø–æ–º–∏–ª–æ–∫
          document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

          const selectedTitle = titleSelect.value;
          const selectedChapter = chapterNumberInput.value.trim();
          const selectedRole = document.querySelector('input[name="role"]:checked')?.value;
          const selectedDate = dateInput.value;

          let isValid = true;

          if (!selectedTitle) {
            document.getElementById('titleError').textContent = '–û–±–µ—Ä—ñ—Ç—å —Ç–∞–π—Ç–ª.';
            isValid = false;
          }

          if (!selectedRole) {
            document.getElementById('roleError').textContent = '–û–±–µ—Ä—ñ—Ç—å —Ä–æ–ª—å.';
            isValid = false;
          }

          if (!selectedDate || !/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) {
            document.getElementById('dateError').textContent = '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –¥–∞—Ç—É (YYYY-MM-DD).';
            isValid = false;
          }

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–¥—ñ–ª—É: –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ
          if (!selectedChapter || isNaN(parseFloat(selectedChapter))) {
            document.getElementById('chapterError').textContent = '–ù–æ–º–µ—Ä —Ä–æ–∑–¥—ñ–ª—É –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 1.0 –∞–±–æ 15).';
            isValid = false;
          }

          if (!isValid) {
            Telegram.WebApp.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ.');
            return;
          }

          // =============================================================
          // üöÄ –ó–ú–Ü–ù–ê: –§–û–†–ú–£–í–ê–ù–ù–Ø JSON-–û–ë'–Ñ–ö–¢–ê –ó–ê–ú–Ü–°–¢–¨ –ö–û–ú–ê–ù–î–ò
          // =============================================================

          const dataObject = {
            action: 'update_status', // –î–æ–¥–∞—î–º–æ –ø–æ–ª–µ 'action' –¥–ª—è –≥–Ω—É—á–∫–æ—Å—Ç—ñ –±–æ—Ç–∞
            title: selectedTitle,
            chapter: selectedChapter,
            role: selectedRole,
            date: selectedDate,
            status: '+' // –°–∏–º–≤–æ–ª —Å—Ç–∞—Ç—É—Å—É
          };

          // 2. –í–Ü–î–ü–†–ê–í–ö–ê –î–ê–ù–ò–• –ë–û–¢–£ (JSON-—Ä—è–¥–æ–∫)
          Telegram.WebApp.sendData(JSON.stringify(dataObject));

          // 3. –ó–ê–ö–†–ò–¢–¢–Ø
          Telegram.WebApp.close();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –°–∫–∞—Å—É–≤–∞–Ω–Ω—è (–¥–æ–¥–∞—Ç–∫–æ–≤–∞ –∫–Ω–æ–ø–∫–∞, —è–∫—â–æ —î –ø–æ—Ç—Ä–µ–±–∞)
        Telegram.WebApp.onEvent('backButtonClicked', () => {
          Telegram.WebApp.close();
        });

      } else {
        console.error('Telegram WebApp environment not detected. Using local simulation.');
        // –ï–º—É–ª—è—Ü—ñ—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
        confirmBtn.addEventListener('click', () => {
          const title = titleSelect.value || 'TITLE';
          const chapter = chapterNumberInput.value.trim() || '1.0';
          const role = document.querySelector('input[name="role"]:checked')?.value || 'ROLE';
          const date = dateInput.value || 'DATE';

          // –ï–º—É–ª—è—Ü—ñ—è JSON-–≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
          const dataObject = {
            action: 'update_status',
            title: title,
            chapter: chapter,
            role: role,
            date: date,
            status: '+'
          };

          alert(`–ï–º—É–ª—è—Ü—ñ—è: –ù–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è JSON: ${JSON.stringify(dataObject)}`);
        });
        // cancelBtn.addEventListener('click', () => alert('–°–∫–∞—Å–æ–≤–∞–Ω–æ (–ï–º—É–ª—è—Ü—ñ—è)'));
      }
    });
  </script>
</body>

</html>